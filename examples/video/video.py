#!/bin/sh
'''which' python3 > /dev/null && exec python3 "$0" "$@" || exec python "$0" "$@"
'''

#
# Copyright (c) 2018, Manfred Constapel
# This file is licensed under the terms of the MIT license.
#

# 
# Pythonic DJI Ryze Tello Workbench: Example
# 
# Extract h.264 video frames from a captured live stream (video.log)
# and save the h.264 video frames as image files ([seq].png) using FFmpeg.
# 
#  1. read raw video from log file
#  2. pipe raw video data to FFmpeg via stdin
#  3. ffmpeg does the work (decoding and converting)
#  4. FFmpeg pipes output to stdout
#  5. Output from FFmpeg is passed to Pillow
#  6. Pillow creates an image
#  

import json, time, sys, os
import numpy as np
import subprocess as sp
import PIL.Image as pil

# ------------------------------------------

test_frame = """
00000001674d402895a03c05b90000000168ee38800000000165b802057f0042cbff8fdd7ab0d2bd213b6ab12690cc2aa980eb1deb4d190798981aca2bea4df73c3d7977c09c8a1a6f3bf3263350dc1e38c2c5d04e79c440d691d7a41120d6cee7670cf60f342d0a2b4301ab1be189c228471f2ba155d683ca73d56dad2028ddec6ace95baf47bd791618bafb2121d15bf6857c1969ee46d1d4a513c5db4d2b308108ed8aeafeceba15c76c8f405216a6c7528db3b5a7913e404ecc24d46643c11f3663e9501431052439e69499227a1fb76ff5e714ac14eb97339b1068ea14b51a8aff84dfe9b1b26747c52f40b094e75594c71a41acb0a5c562beb70f27b014785d46d68958641ff6a551d9faa8d924bd5e38e77be8e9a116a01bde85f3f670411a188efbbec7d4c34d4f5ac4aa04649e1ec9673772caa20f93e2c7f4c9ae8050c357c051bd8326d8091087b5fab664efc6ae13ddf2b5e0e12fc8f880daec192cc1871a9cd35423ddf93bdc5d0294cca998290a1fd79bac50fd6179b83b7af9cf2b04437e3afff99387339492165dc78be3bc679667ece09633944cb99b995ba1107f9dc48c53b550f80f87b130596fdc771625df374460e8e0465ad3b2825fa0cf86912d9a2dacf1b1b407b9acc5aa3a2b54137b0fc23f9f6db77aa473beb6c862bbe23f8ca528d62f1ed5c5e4d26e80c78b6
b0261a1fac327e7da79352b34b12976c2b718f38f39b7f718eb032d981cdd24743c65cec13d44ed57f1e74f635ab079dc12a02889ada4aaba69dfbfabfc77345c396cab6601f58b6e9a12c80a3a5eff8fadb394784457c68d8221397886b311128b410265b090250bff5e0d56c2eaa670578ae6ce6517fb882241cbf0aee2cf326f809b923f07fed9e6c63994c2c333e49736728b50639ac060636aacf754ccafedd8be51bdca954bf4d49e3a417a053bb957d26dc3fa40d83fb32e8b024345c460f98a143649830b12157f2363f0eeb09d62cce719e37d32933bb22ce620f050da53459c5dc9f8d75a2e178701dcfdb6ed24993c17d9db1bba7507f19aa5ad2471f4022682c2d5f38692adb548724a1b0be7a3514c6b589d7ebc106e8acc3b171315d924163f3d0c53fa1ade1081fc2cc4fe8cd4903cdd7098660e3712d985689b0686d3786d3c4c656956fc55ffa24ebbbea1aea2d7851f75b8fc43c246b339dabd73a7d7837e53dad2ffc864c0d09bf40c0cd8c4218803c74c78fc4a926780ba151678e3ae8a45ecdad5efc49211882749ae7f7afeb18c68ae33428dc2c9d99a5c2259e168bd78fa8beab34f6ff61a5332fc076b47472991c927f5b82511cb1d6523c93630fa0f82f3a934db43dfe1efae376985d14586f76ccedce3d05fa679971f090efe305c7182c946e27155b86c0a152
0fdcc413f92666a9657f8101250937047fd220c9f6e31049c7c28fd30bf8e8edc215b761dbd5e8a39f767c68bb5c4359835da81a7a430ed62a43af844ffc5b06e2f6ef2a0c2104fbae424cb37287600ed1453a36dffee681ea70d3889e7cc29185ba321c9a4f45e1bb463b748cdbf76748e10da965f11da6b9b6eb1e7fa7904d14df4151ff2ed1fb154370fab74cfccb0dd13093e31e0a93832ae6b61df8de5707bd8e3c0e152aee60debdd4c11c00f0754a73df2008bbb62e8e016ddb6db33c876a503e5ec1349485fa6f806e622be6b4461f19e426ed5a9c2257cf08a7907f81ff762a9faf14cee0459c78e719e7f85bc765b857b138744b4921c2150a319ef5b75d3f0fc153f1802d10ff13c009c753a094b85ced49c53e05316f9f8656d899ed4e169750f2f6c7d97624d86fdb231a91b6fa03745030e72fe8d4f1dabc32a96a32306f8c69e4048287f0c470b042ec10e86cbaac12e932779dc7f37353f3d912163c4ed5d2e4dcc9f45b885d864c07468d4c4693265c05ba937e5309c324202aa9f563ebe5a459f11788a03fad4be55e6c10efc4f5c4ec3bbe5ea18ea7945a426dba8fee59952c60d065c650898391dc9bfbf9c08f36e297c76b5fa70fb69078ba32460302cf7f9b6530d3fdb7ff7832d2a8b3a6c4d1e31e6238a756a2bb91f8d9fe8f51a512c6e156de7e207c6b1ed9bd47
8a9331bc042ab183e1a653921713c5fdee5208838f28131326771c35ff8d4a1f76943d3fd0f810dbbde7556cf84949d526b0907d873e9f79ef10ac284cdfcde3e5d393634497bc525f1608b084dfdf820ae60c87210a4c6b9f54f3d138c9d14c79df190c8d9e20951069f178c155dfc1dd029de2617b06fb6580826f08233f851ff1fdfd055decde40217dc555922c3e3011d9475c50b49550c6f8925e43ac05c4731ae452b513e300239ed2cffa2e3c0d445269b47d1b4e9e9a91ad36810b0fd0e0a0beebd978703051a57dd075174edc173fc42cbaa88261ecc62eb78652a32e53c3946bfe0f319dc65df6c5ab18169b7e41cea030a02c0ef8bffc68be0de8e15c373de15d9a2934907307a346be47f44749fd963343bb4a3123d0b48f543da6d229a8c61487011574077777050ef02d971cb0a2074ba83ed0aaec0bd64b7528a5c0e7ada5599a71c438f0788ef034d1265ed6f430c055b123cf6a1c8449d989f784fa0c89d3b11b3019a05ddf703a02a3e59b150390d36e17bef8a5f1a515ff5a51458d117d2041597b8eaf7af2f0bc14458907739563f1bf469c4e51c294a7185b3336f1c2c588496e9104f93c2bfddfe86a22bc31372bdb27435e130984a20557829d329807060be77287cdeb59d4416260c604532a692003190e7bbb9e6647cb447b12cebf2b569548ebb37d17e9b19566
e007d2108454d831ab748926e20ad46d226b0890dd21cf020a5e6b6daf528161ac29b4c9926636ab8b700b8a8cde0e173b25dfc36600e0cb9dab1f3ceb21d903e20f1c271bfc5240745b2dc2e03f338f459daa457a06265d4cb5b419f1a1d30420cdef9fc4ab37febbf2ab873ac32980149c9b59f7da0313d41c99b304bdb8676c9083a4b83711b279386417e539be9fe98b3b71b125bc274ab128a1e1ebe60e5ea3768c9ef89392db703343f214d28c15bc0e6f99e82cd0c373147ac26acb2f216fb003bc2ec31b1bca53b87c491e82fd8a9bda7ae40c0e6e238f74f9294810b541d54343b88eb1ef92f222988acd1c57a5c6692a2af0845f786ac889c07e3b88df1d222ab7385a5d69d0623ac831e33b906fce628ba87a97e7159d3fbfa38428744d50a6a751bb37af1b2b7fe1e8256b601d794525ff937f4904efd78162d50561d5a3391150fd638c83910a110be1e3e5d4b7baac2f290126c40aece80a81e2298016466fe87c2244191078ac883fdc7fd43c771132a191b39c9be76e10c11fdf86e4f76c6ad8e711cf3835a5f6ab10d1f2cb4b982f1b5126f0b811242e4c15928dc924144ad39234ab5996170b2f4a19f612435742d9d93d7633f6d99040a213f90f11560250dee90e8f190ea02d48d6ab57125fda8575316bb7aa51ab756faaa8c84758f1013e21ae1d364769c15a934455
3375757448fa5455aa36d5adc5b8e7a7991a15362302b1284ed28160612f569c5cf7973c5965ca979cb8fbe8cfc97d7bee5499e2562a9eae1aa30466b9c36bbd15e340e588384d875521f0b2524f57022cd7e7ac987560acf46985afb9230246306c83f031a9d1611e1c4f0c31e9875cb00f432e6cad806ffe2d384960f8dca19c8fb613fdae5c7094eb783ce7098df1d59a0678349cafc9f4efb853a08298205d479b9793d1250527a020655bda7531af7efdd48069cf0b94e58be314fb5fdec746b071b663c64e27e6a5e2dcda307a23871f08281dddb7732e6bbe9cd40c8676281f1d8daa279e62acdcdd322d7f37c5e522bc6f70eb2a1a1104fdaaad7041b70ec211cae940c7528be112d11fe6a6f47d291e86d1f4cb1341b6a8d2e609f737e900ab8150e1b79a8eb628c91e9b1e20fb7775f0ee4472511204a6c94f236ceb574fc0774c75e10cb60bf68c68f0d609814168d80db55c36d5e4b30c1aafbe36fd14358ef96c8a7aa13697f70db1c5540a806bf175138b6749da11f7f46c04a75de5108fc7d68134a3ea491490c0b342acf5b3e9e5930bdb1e3f546e42a8e30d1a8ad835244a81130eeefbbda3e45726bc9fe23ebbff1e0ffd2efc9ced0bb93215bf90836992628ebe6bf6b9f5c35f7cb90c52054e72a3445137eaccc55b6718ff2b05b8845e2e6c6ad2c334703701a73602fd
7fc915d9e5a273bb97c4b90813d4397a858f88f5bd10b5b5a0f18cca702899e51550fdc4c8159893dcd9823b104abf58a292fe74637a88fcd706b00478d40bc4e399b77beef3b800c8930c094fe4f831f093efb7ba65c199c8899cb1d798c58597e5b4bc4c2e9600e7831ef05ff37be9ac2817b6f4712ff9eba4774f4da4e4191423dff007c187db4b20d4db6e32ce8cf72fa3c39976c100dd04c12388b6e9871e44e860ebcbbf59bdbd1262eaf6abb1f0fb3e555f0aee5fcc6ee32e545d52c58d30df1d641faead2cd9b07f63b3b9c99c3897fa62b668e5e407ebfd8db58727bf02e3defca8cca8fc85475b98b45d333f308d32d3672fc23bef537c7333d1fc5af1c004c720dff8314a5d378647f8a47e35f77e7e5675ffc1b5d1f49a6b4a66909c7ae53c3f531969767da2731d67925ca85eed759370e1fe2b40ec56363ecfb7dc17d2be35822abe8745abc1596e232929b2b8911174834cef9ae72a83e89d77d3bfe39f17c0938b7f4fdcfc0a1a98a3ee72abb3ea4b41a06da8a323746be56d5b09b9d0b6bf24a3fc0d10c075492e3a8a35e86501632ac0a8624b3799ddb05cbf463eeb0a37da240000a8aae2cad1f5b479919f85b6a184a28391fe9471982af7047ba9130a45b56b3704e3a06acad838294d8095129c308bdfc764710a4394c3742761d6d041108929d44d89c7a0c9f04d14
d2c458c0e32c56231d991e50dbdbe6cfa7c2db7fc4d458d9550dc8b9f5cc8d651d2ca41c04a7cfd3caa9f71d58f36660849b5054962a23f160b37dc5b787a6310047e7c9e2b231393b86617205e6065ffa3e7361c6e50d47c190566466fc7567779e6dc22c5717004478942b88beb4faed6f1ff48019ecb6512ae3c03a6143bba2f4754c6a5d201da04e493fc637a3d228ffcd43cf9080ae3ead5d56e8b0675bcbfff20a6ba0a76cdbc8103886a0cd20e903ed353da3133948af5bfad784914d25b6c46b0a6100d2872fb148e9d53a68af22dc158fbfa2e7fddda67324637ff008ae06216d66e9b7ccdd7f653f8f5e02e7385d7363aa069c3dda29524f207b7039fef1c01087aac065e44888f647fddccf367d8909a429056989646f084419628971aff268c236488b1324bd6ed2eb902e279eef739e9d555b5a28909cb856fcfe34ead95fe951cafc7fca42460801c9c9662da3e61652098f8eed15972e17e662d9a0c353bb2ae26c17bcc951ba83b7ed458de1964cfb9993f0877ced6f24f84f3a352f5f0ae17f287be093dd2b374b19a998d4425fa4dffe14ba10626666fb5f1ae850359e869e065b717468814e6055c5944b3661f6841a8f3e63894b5a053702a916d4ca08eef38577e18a5cdc81179a348c2832957b3f19e2da40b60cf4e2ca24e3aacad3c1afb8599f33911cd6c0d2d864
f1ebfcab86da04d3b6651853e692e0d6126d04a3b7d6271200c23c7d4ae246758ca19e4c576b69ee7db97f40fedc417bf69788d78c2d2f7151beb019b9d161eaadfe0d06042f1776b78080a3caae02996a5fceb1003472fb859ed9bbf582ad1b6905feecc0138374f5ec41b992ed37dfedbad64acaaae0b16e7005ff3c2a0290389471b4dd0b90d2baa7a9e8eb4966e52c440b37f31bec2c36f30ecabc296b2a1244a97c1b6f780a2f75af04a0a5b6ebcf8757c53d9acf060df444f206d14a1c4411be0af83003ff95f3107198e62a1cf535a85d3a39370772bdfda3cec1a1e108e244bd42da02ff14772a5f91118eacfee14a67424dcf565ef07fe8fad64ff1502c52605497049ed1c596be3e4efb315729eb1d70717ff1e156609a0faa7b6bdbcf0c508abae1bfacd8002a0effc22bd8aab871a54c5a13c2e2d73e148fea0781f7b90463dc4cc4b6c4d399779239e13ef29f0c16b453bad0a0192933425ede1ab72d1289fb99a4f7b2e67b16708119c0becbf77d340a33db058004d86557bb17f10bd49766640a49d980db98c629c0c86938004ad29e03b9ff1519780d495a3dc155e645c97f4c9d081f88dacbac320bb04537b61a05becef03256ca3dafbde554e7b2ac1f20652c6e2ad7b16ef71f4c15f452a90cfe4e52b94c0f387d0547dbf2ad9f07b8d79dd145c90fc12e77f527267ead
4653d30e8d1f03023459aa9fdb41051b27fdaad3015f3a6e6310699d4d083e4a34f93722dcc5cf2c0fbd3865c86ab51edc29eefb9d71f0cb44735babc2578285d55a5ff332fef1eaa10547db2e0a0c4eacf9e787ac8c9272df2729c5b03dd28567574e4be60fd7cef43efdc000b8a01b95a0be96c2cfb8b1713ccd5161a260355bb4f15b4cc2f71519e6af05c72c120ad73f4e15dd84ef3d85960cf171a2e642ff44eb40a4d38950fb10b5e9a5a20696fc5663abb70da0930656a3cd67ab3361aafad06052886eb29c191ef3efab4d120d74f4de83f0da531e3129690b91db08c56317affb4ce3fc314be995dc90fc457791a8b3eca5f657b175ef777c27d657438007ee15b8fce6a600c6eecf8b5af05261ea9f2b0db7b7e92e30c95db5190000046e486f9c2d5896cf9b84fe4eaa8770ae7f48814015260b9245d1b3dc299cf648e0ec7898aa155b922045a28b2066e48e4cbadab3c278afdb9a9b9d5e12685e52e40f3b1343494d1f196f2af9abe43578eaee44e575ea61e94779cee0a0f1379dd977449547c6482d252dc00619de835716a57eea663916e8a4902298973a9b6b096e4fa06a6a6b4556f00567d4b7b7b5484ccf955d96bc94aec45beb64a8861977cda1170b359b9b2fa370a66228ca1250532fe00f3c83262af5ef120d7c3b3c2a397b290469662527ccce47065f0d2f2f46
0192958ba14ab5b85504cf18facb2dd07b18b081d3ae19275fe29e24e5e918cf50ef11778b10e7b3ce542472a11d0687b9298111e07cbe94c67e88a83af732cc2314424a9131ad23e4bb523af3b378f366b2996deca6e7da47b4ba13a3c7e9b77cfc16b7b3227f379164129416a955a5333deb280cddb91822a226c176ca38eb207c1a7d1e0f602b0ea1d60c2957c493b18bbf7a07225763fd0752d7a3f2b8102d7128156e4c6609ceafbf5b8290ed097f846cc392286940be49bc4257087d4a323b099565fb487b8da1cef8bb6a13ee5fd25b4e211891ac6259ac05dba3b5f27169a93fad9c3a1b7dd9456befe0529315f1a49a4e031f134ab22d2466ecefeea6b8abc365643f28a977ba44e33fc27a5a75a05d029f7cd360f029cc0c12a01299ebc1d907667d4344fb0a60058ed613df43f9d94a3234c97e9eb0e3997fb2e90eda5639e6a4c7baf90ac1774dd7f1ed8fed9e1701baf5d45240972099782e0d6f60bee2f5b94aee18d48723f36c0ff71298fd20d7eb5efecf3e7f1847aae111a18932af151e467a59da19d30d7903c4f55168dbb375b52e161842b0201e7d35855c9d111996e31653d7804d7541ca6e5ff974bbe2f8b6c7768c72954f6074b4cbdca030e047e4aaeb6301f5bf05ae9fc676b4181ce4cb39434500b04428c5a584f275f5a12c0ba268fc647080cb5aecdbdc6f9f
a19cb0d72690490e58e995d882bf582d3494577e31eee5c70d5c20dd08f026f1a626350484c7f5a2acf3d9093a3079fcf3987d9ece7c230b591ab2122eae69320809221fed9e4956640d26d1f87df50442eb985d35d26eefdb54fac94f06081396d86a3f610b885f76ff25122175dda660737d35b933709f9bafaf3551e0e31368473672caf69dcdac8539117d7ce744b17b18021303807185bfb3bb00df4cc3f686bd1c39c1c2112427d8502d890d5d8c012d0df0eb4c5d61bcdefbed759743bdb1bc141bd978857329db068b72b3f57abf7c747a6bb1c5f95ff637eb870e5f0b99f141c3c25889fbc0e704bff4338f613f959c8901551ca9a193bdcf799de301d658f72afb7308c6e6cf4be2de99580a8ce6dcca02643be720af01dadc117b44af779ad082e6228f05252d1c23e8620e86f50034936c07ef60173b8d90e83807e8f2a65ce1fdb6a7326cd0fc7df11d66f6e769e4d9f1037a82863c2b5ed662d47dfeba72680f64d40e2a7cf0d0922d2df8482ce6e13b2fed264af870a36eb600c6de805d3b8602b8c9a3e4733755cef6b64643b6dc0b8b02cab453ba50065dfea1c836b2b7f86a9d299ac8db6e695fdb49a388968deef0185afd76607efdeba0ef7abb249cc286ce17a8cd743b59399c78da14f2a757a8a56df7f8209b3c459e27385a195c0050ddfaf86da7d7ad8750f77f85
34910edd27cc16efc7afa9fbcbe5f19acccad70db4ed7889eabd8653f66d90974eb5375652d6c019b6f89446e5b322f389a612188ff626b6f6e9aecd96f52cb8145f1e5f81035fef5788444451fdae9588d98bc1e75aeafaa4ca3500f5cf8fe035709dd38a84a2a3e5529f4939ccac2a6e5023a7f4b413e7de5c91cc5112b3fc79c64397ebc8beae5658c4d0820a89cf34d997b46ce1ee98a32a643c9f48573af7c6f0b7cbb626b2d43ff5e925b2b06336de4f01ae41d45662e16fc65a9d7c0e962ca47f0ab0a8a18a95969f6051221f37f1873dfb3ab3ecc3820be392355f7fef44b23d6292c0392b198d99f9710501d1b51191d6e2f7fd49b38802708f3f8b429b6abbe8bc4580cdc7af6eb670b89b22438316a5babfd43c61bbcf3658b3263c5d9fe3db2eb040c9000d6e898f15ac131156977ba09e60bce578de62a948b18eebd77a5a982a68c07b605246deb8614fe72b8a4c64ad65136a317de8b1bf2bed8c6126925df39fbe67c655828da2c298bb9f889437189adbe619012499099e886f95a84f46a0dfb47e6679e168d215e850157317f0c5f85082ab2287ad65b20f35e525235a25ccb66554d8f294bf55663d8842326af2d67065ef3c4f2090f5deced3a79c94dcf929794890adee28a49babba903a704b8f98580bd03f3a8a6c302d4a82f59bb655ad36d6989cb90a53314bedf4
924f0c29b84a7e097042009d39c08fceb711dd5b0bfa19b565b13b7a7b3111ec2f36a7f252388dbd3cef5125d7e91579747466bfd7b5e2b1c1f9f299a87bfc54a513817d57624813f5ae15d08dfc7b2085d63c75474a2e02ccb84b07018170aa7030f946ef9080736ebc9206551b185f4ef9e5bcb867ba401cb2457ea543f15d13403cf80804e1e93d27685202c452f69d3067cf532756440725bca19c285a8fc4a0f88aac87f6e6a8226f22e0c49105fc7f931984ee1e7f411fad3aa5b663b7aaf38fe43d3ebf1dcfe7cbd2b82dc0ab24014746d2ef460b5caa9927205b443881913652d952d31e9af32342c3797842a7e52bf53b28a0ac7a7a9018a6b07275f8eac0d436a7968ebe2ceda15a99f8f05ffa23215a5771336a71d89a82225a1654f2b2236d66109a5d2e14b8c199c278d89a8a1175ead97f0f62cf050a8862f2db75a8ca60b9150ccfa5dd4ef3c179d2fd48d3603178bb839fafacd2c9b613293f1e0c226b5b475cf08442e0043a3321d20e68edba3350e8ec45bdcfc1dd799c3af9e77f0a029a2b49892d7873b1259f38af796f5b553fb2afecc063e636d3769fb48d926fcd070355f4d650462188fa3d1aeaa4ba0b965091f3e946cceca8e36ef29abf5a902fb87f83e07c3eb5a5a9af8ce2f486a6feffc4ff6dad94774c023bece739c0b67a7dfa860bd602a317a200b8dfab
34808f30fc797da7313d2e371f78d17bdf87b691c7d78e2467f984f90659740f78abb76c1105e9ba22b6bcd2339e3eecbaac5f7a0cd452886f7aca84b048adb56805b0c08cdee0da02aa0cfc9ea5d8829e6a5b727cd245b2792b6283acabc5ccc636ae4e3055d90b0f9afdff2e132022e6410ce1618c723c9d4984494876c59a40e4dd68f864bfab18e325e290380b67c7866e745720be9b94236ad0d6ef8f033dc1524f8fd74d3b83e5fb6d9dcf367a50dd32292f5c097e8399f74e5260763528830af450e004b920d02ea94b4fde16bbd220128ddca8d1a4bbd229d59ccc59cc5afedda182c743f303884e6d904dff53a627a4e32b3f1d3a0a6eaf2535a4b8b1b3354554a64ec5ef5172dc5d985fa8cbd82be0714fe40e0a08054b8af3b50b609c43d8ae77a1d6e56562d0094598865e15f4167d0fb7dfd5cf84208474db02f0f25f5e0f9852e1defc8eb06d677cb55b7fadfab917dbb639f7c709f97b0440f1516ece61ebc9f2a9f6be20a4a475ca4821356874c5d5052381045a2997756bc74c586ed2a10f4a7b80edf0783f9f05822407643eab10205bfb5012660af25e19621d2fad31f8439b017e380a22c5d3bc545b6da52b202eeca0b0d2389b8f75eedc4f9f7ed2e2dbc469310ab0e95196b5aad3d6108ddbd32a7ba7a17e840e99645f55aad8fafcf80519ac37237aebdf8dfc0ed9
0253a45d407ba55947a169258815ec709f2a76aade7370b3ba49c189726d636a85932f2b181aa105b4f6b6d7a861d4da830cf9fa01807fb59a2f6bcd89fc1095a3029372e991e8d9d5385a74b6fe7af4661ff782fb6d09064180c28f01fe386acee478d0898009df227f9d71ab0a9fe319557f8d47bb02516a869c50f571fac49012589a23dec2ea8a1cf37279759c38c3bf1381ea6842257bfebd592b0d715af7e6f0e1888bb3b84059153d56c783e005d11405e9a76b2c03d5b41051f852e1634bfb3d2a7c1ddebd5f443d9f385cd6e5162350b497e3aa2b659048e8e6080429c49dce51f0e744c048a4b7c5216f9c622839418c596ca913284b5f79d3796759f1f012c907ed09a2622cbfcc4647514dc4389c4691594fc67c897e823d8b3b4949dcabab7ba97c84697939626da2461f6776d56113e9d59c8dfe415919d2c7e662e9fa644b4efbfc0ca0feeb0c1c7ba6a5a81178628acc029ca869a70e0ac94da446649d4d5af53dd1bdea56e1c26b90c5755c5caa806416f2109500c3b99d05bba7f9c403d5ee846405474e160f761ac57d7062deed937c4b8a39f2f7af47f2b6222068601d715476832d3ad410d1fd114e9996a25c7b01b1e810bbdee50d5aae70003f96501e182d1f849a3b1a57cdbae656437a37ccacadc725b8829a9cdd7863b3276a22fe7fc5be33a4be79704b3bcfa4
09a52441ea0d3830ad878c3a9a21849438cbbc29de4fd418101a73c63eef7d8bb149ceba76e490ec19490df51c75db5fdff21c4670270df8f3d554804d53c3716e889f7f6ca38535b82fa6e44cd29d17cd130b93c37fe33d6de236498d28c710bcb36c1e367d824c12678225f3971ecb0052af7330a905b71af4d86e635e61b58593416d0819408717d976dc15a227ebe301b03a79ccbf3541747d05cb1990b12aba975320d3ae94c744d8522050bb3d19908262bc18511b2ed805feb7aba0dc2b7a5f127e9afacfc321892b5876ff330fcb09e7c2ddaf170d1890a9344a611353c707215d2831fdea697db415ebce1a3860aaab4703860c13394e5d61d75a23924b5ff676720af77dc900a198b300a66d7fc44111eeed960b2e84f98f67071aa0fb035b6ecf572cf42968b6d1206423565a46eac774d272dcdfdce019010f98656be273be83a4ee2f375286cfa8b5976973a091b12f9d8e8fef1246b6136f6f31c897ed67b7bcd865eb128d72fdd2585ecabd06eacd2baf7dc9252e8c0006f0d05f27c2f51abc869669784b2d5ffa34e252813b70e970c29243f7d62c5f4308fdf94b1c141aeca61d6d9b8ada1c18b338617306dcd6acfd1372c4e98c94b5d3627333c891fc8fbdec8af272ffc87b6132c84944d986f3c4ed10f4806b3a8de5468cf5fbafbb1e602431d115d0896fc2d8879274
6d27a3c9d986030fe5ebab8e2a1362eaa55608c8ed3283615df1b6a3013f2baead02f92e7c142586f85392618bded2fde7f6936e38158df46cafe9f14c7bfcae67147536b913dcf107aec60baa3f7baf7e104a76443508909fa9ec3628d32c24d2891cd662173093a91739d850bd25f4727c822ab08fa7c15ad3c10c68712232cb43374e2a05f6e4f65e760d5641ca9e1da31aa9223f0f5b76da34defee2946edfc68a5d767b1a77917d44f88b4587d643248ea5fb606048ab13a00f125388afaf3ead516c989e85a6fb0265dde41c74ea92d7484407fad97032c9c3de3807d4991e3467a3217459510060a85b247d831b792165d71777549552de0cb7da0d1c98f7f1ad8caa00b816a8cbb1a201670c0faeda40a448342391ee158e18ce6475240b3bc01e334ffaef61112b8c8ee7ac80660e0a905dbfaa95c2a671c14d6c63d236286cd14cef03fcd1814c8dfe9728475bf5224749e358b50478a9ce7e64464e38beb5ccc7839ecd1a9c308f5372be8f3371f0d666d94a67223570f7896b855e157258fef82a85384c69185a7c0c0a997fc26ad1db79f736051dba1e8e412dafb641e1da5be90f5f17e19d759a9249394d3fd22a892723d4c0e0f5bb08d5d9bbf0865c029b0804c0539277bdb47e76274072381bea23bad224ba7f28e1bd007e11ab4ff1fc59ef8179a8863b7ee19eccb744f5
6686860d082bfbe9e9be25f1469019677220ebea72a43511e98a7a3d29dcda95df943b68250f4c0d403238498449c6d79c574da72f144d3a79f3ec2586145613b15b22d608d73bf228950d0abe87978cc2a852bd550453c1b560a21eb3d0f13057030cf7b1a36dc79defb842719a3d236ee32482cbf5d9e54fba66197349934d0006e1880e8cc5e19bc964af77ffd6a1dbf9a09e1bee1e5545a22c0d43897db31d463f0847aed47f30e6976efebf967036f32c323dc93e5dbb310756eae4bd83244f1277a1f94f97c2017c26457bbc9b5bcaaf8bbcfcf60dab4c4d839c66e5dcbb2975341acddc569bda4a72e671b8d46209a3750f147211de7a23681080dcf4e2e8b3325e5ffb7c160b3d2f8c895c062a4846c32f0d0b42af94f4ca692a6a0eed30ad40fd18c85a6045cfe9752bfdce5e7c453ae608ba9ef511b878f0da42cfe35abbcb3368848bb03230fa759f7c48fac0b02eb6bf2f6d58d0f601ebe468f5cd95312618093e09a90324a4149caed6ea0e88e752803179c0f765d0d9c1be0bf0a11e3db789389fe15c070dea87da9a287de4984d5b524d03d27928b50bba77d4770f6ce40f3861066e15c56f10fd0ba2f6df5bb4fd0afeba4eb546f10cf41f2499f6f3642486173ac3c04b0fd088a096e4bf8fedb79aab355a7d152ffa46e27010d9b2b2c0dcacb6bf747b5e0831eb4fa0767c
36429bc5630bb710f25a4607dd9b37823087a5774c3d25a3723ec08cba395d5bb86143a37ca44da2df3fec74f43311a6f261e67dca903cf2b9c0ead289ff39876436c6c806236ac413e3c80f14058a429c84f1536bf80b87f0cf3db9f0d7ab4cd4469fd7a7578b4a27ab49db3a334d40bf5022432a5f7570339630c683178e5bea69c770f6ce9931d56f7827a0b32ef57e3d48b8dc5cab605ccc883f27180aecb19d82fed9fd7626cc637a5eb6c8de76eec3cd1b5c6e7343bfbd404e373686130eb678b4eaa61fc247b30a8620d10fc2de52dbbdaa69a2ebcf1c6848e86fa0f707fd0734f02742feed1da4b767ccecf0eb99e3c41c6c1c785a2754722e8b2ca328ce2ef23c9abd67ab1fd2eacf888a872943cb64733ea98d25214e6b0b1b6ce218ccb23dd85cb0bed068382c6a872db9a46a7a0a2e4e52e570c3a39570ff72edcce65b68a82d88901ad87f3747b75174c500e93a437fc5c1017f3d23b26067a28e3799fa3cf30feb62e2b168b50d60f99cf9e74fe58cfa7f3d8872a1e8246927eac2663d79f8faba4fa54a3adafff7a21d5614571ef30ff7fea765a63186395b63b1194637dbb85332fb7c91fb9ba996d49f4ed75a6774f4a00dbe17e152aa973ae5a0785fa7595f6936f34df2d4d8e2815c2a75f7c461f482d50871de8f0adf3d9e9ab72237a8643a7469578b7a8e34fd7fe08e
9294d1b1ed1f1b49b767b448004822070d8d8a9cde9f74bde934380eccd1202ef158366468363ee6d0c1c9da1fe80427a83e8ceeeab4435ecb96318cf3e8482b2d78b5b1710aacf6acdbd93ab75c514f71e7fc7a568e8e90eb095c6598ef96a12647ec1acf02b290176602ce1f3272b25b29bf4a2fbf0d68ce6643cc7c37f36f6bfeaf4a3d0f37874e33a592cd7c8bcfe1d3e885a7e239cc4251e52edd22772454c9a54dc5e439d1937a53112ecc81f0cd2dca3325564a06b81b087f8779f188e598e6d00842e8fdc526e1d05142395d7c0208ad0fc5f5e63afdb18ca4adcf30e207fcfa47a32c8dc86b2d845bcc78c57518ffb819518fadc9724f16b05b5e3d28cfc18fe4f35e4c73e2635e22236cf55a1b989fc6944dc6b8393bc4745556e9684b141dbf28601ef2abd6d7058a41f02e85e19590be1afdc36dfff1a1694ff99530bc701758aa6c5b2dcec8515b1a45dc7d27dc2bb63835f2e5f85dd240a4a2260f59d663933fcd25ae9b9bc3f983bc09531dc545163b69c51769f04c6c8d4de79411e4d0e7626f4c5e4c3868a77aba2d9e7f26fd30fa044026ac19a90ee9f628065d5a3f8e73474e4d31ebc1e1a8872582e8929e5ecd53bed74dba25d37e6d72873bc80eefca1c734297d1794dfcdb16c45a02ecca2b683146b35046e07c2852dcdfae2488d04bc5a61545c83bc2ad10dc64b0
abdf16201e8c3c6b836e59f4bb7c03051cdcbca8b5e201a3e9f3ff1e7abd3211d9d2aafddc5713a4ec696e624dd694dc0faba9668d714a9285fabf2271726a3b3a8624a908f8cf899f711362f8edc7c6dcf90546eb7ed8aec574eab7a2be96974079b608d6ee1446ef557ebab8a2bf1d13127d3dd8059bc0731ff3bc96f3d679ce393a9448684634261ec8e299d2a4860951187ac62227a7c7618152549891a9ee1f0ae66f8ac708b3960d334e826a48434ac9f97195522e9ddcf910290ac340ba3d4667051553333b61168f8622cfa08b15f68790b66edb449f2f1af9fa7ebed4e8b0b16cca43ae7e736555cf09309ba4f1e1de7cf22f6fc46fecb32088e19df0945e212a8bef40561fd2a4b8aebb9ec0ebf02ae67bba87f05ac6d347ff45982da5052618570ae742c0a8da3a7b63b42a3bcc7ae5f6366007a30fd8a25f60b282d2611b11202cf3bf9fd51a6c40c8f7efd2fa803f62ff5f8922821d9f60c2ebab8f445c097d2d3d2d481b73a5e57573313ade8847c27b64e75163672b3612ab3fd033b7d83f21ae5ebf36110234294bda1524df2f2ef9af35e4af8c6ca932abee909f4dd9e6c394af94f2a66b824c7f929764fb477c148f54b87d91a8da7552e0afe13d5aca1fef49d7b65faf82af206b5ca5af8e417be276849283e8440bd0d3f340b6f1299af661334f15ba9918c3f63c1844
196fe954990ef720c693094cb4b610e2f6c25ff287cc43cd410c18b11aff34cbb713ac2b9f2d2572e3b15ab52250adb5246a4f685033101fdce9068507a0899b652c6ad6f7d4dcd99ebb305247ea66b247ee1121ee7a7f8b7ef2bf669e94d06d8b46f7a764c504874fd88a49a1e528e463b821821a119db59036dc223ccb07753b6032aded288c9c735c47927698b673bae31b52ecfc5d0d8c8d5b1ca672e3d826f115338901320a4b94a93d91baba11f407a265b2049266ca1087558196b7ae8990e9f1b85698e6615ab75425b0f31a0f15467597d57020bfb55ce2b42313f85c820265c2f0c37e44ffa88c61adc5594eb99a788ff570afc2df615c8815b505010b1f34fcd49ef31a720623569346837efdb6e43bae3c4f68983c31d0dde2c8b974af7189b4ee7c337dee82491910c5b7eee75c985bbcf14264dbea3099105bb837ab90143c968dfa5636da0ce01a5c74d9dd56f10b2973b8ff5a7fe4aaab7a1cbc4153c3ff347aaa1ded64815f7a108cb34582c01564793cd82acf1d2ff6de2cd139232ba8eadbb29094f18364cfc08063704c2187e59b170f7cf374f93c2bb6e2ff999bdf9fca8dbc749f35dca73c7a79a4f99328092aadb0f6f56415f31883e0adcebbbdf992c74547ab5c500dfee33a5c87520289d87a7fbcfe00fa4e27b17ff8e348755f083fe01b97c16813aef1b91894
21e7af0718812285a572fbda5a1095d124d32ab5a27bf1d83d10ffa4a773cfec8f20d05c7aa056275ed0c634fde9d1675fe827f410de020b417bf110e4890e344a7c38d53d2eed52e4de82874770b90783ca179b740517d2a83c86820bae49251a64875f69e98227fb22639500839b34afb1562774626af1c9d1f2a235e2424961ff89a769b105a9a4af3ba6bcef150abeba141ac76331e6a100531fe169e86610b43c26b633c5d2d7ffe509ef6d1a8c0e1d34ad85f407f933162344948cd3fb7fe2e0917dfb575361d7540c167d7d37b2f26642a42ed436cb12ac9b64283bc7a3d914276e4d6afaef85a09291533d3d589ca84d766ff06c1bac0ca23e2f559d2ec528d78e3c5b8ba20c9e9e8648e3d1b03142926ef4e166566887d92b33988782179597403052cc9f53259f28ab4a34f8d31be25fa5e82a8c5dbd2b5b2584f2c4a8ba2109bdda20e8f2364f44302be8ee8401c72eefb387191e8f4e9c36c23e3be117482cb8fd1bec1a6a62aa940247f4c5883b9700fa543a87bb9194ce032c6e0f9a76de128ea25a7015f3e5859d709c4e4708802f96d2b9bc781fab8f636fb555803d1920385ee2c3cc9f01806eaf12871d1ce5fb106431c81f3febedf9bb2b21f2d9f92190260dad1ccb3070d7277a75469bd288327323ed4c1d52ed64eaf7914f25c8ee324812095b546a34af2fc0b950a6
654ecf2ad2aa3dbeb9deac3753d08d37cbe73115d09455e6493108bab82a61f13907ee0280f7a7a8630b03e68b859d5b5368c88ab25687d47f98c8c7277315bde65e06958af4ef89b6aec6435579dd4ed3b3ea3217f1faa9afb154d7c4fbb7d02f1390318ab9e4c17e7d4b22da0e1e7103da67580be49bf1243b6ee8713d5975eedfb05fa96dcdf4f7d3e022010976e7cc99db1f845d8369580e1ad53a550334d5f7dc9b1550ae0c8696dc9dd76fd70dc3955eea23c45cc64db915dd3be8ecc0d89141cbf7fedc433555419bc04e17094639ee4774a3f560eab671fce5ab686869fae3bf02b598d0593f63adb6a44d6fa2efcee05da56aa9d581f45ee6e25dc06483d397f76352c9484ccd8aad56d7e55fae157a113c2c64dc54a0680635398fa6b02041a1dfdd9446c620813deccdb3fbb1f2f15d938887b28f0b07a957f356d2ba772535b164f245281e1208ae3edb4a9f2099a87f3d999406967e73647c0429af50f2f04f4ace2bff45746984387e288b80070b0d0dd228c3b93fd1c3dc9e0939a2ff02a0501a097214a7e902a3053a2439eeb87a9be0dafda197d2915a116a0234632758cfab7ada37895d41fce13eb9dc08a7e1c5b48baa89741c0adb59ed82d3daaa6d014840d5f1f2835c90995cb764d7f56f1600b4b2f4265ce73248682f79b7d07641f6a72b727137ccef8c8ce498ae
bb8ce06416af9f5f99b66f16143a80d7228233f195c1c10db6e05b78bc3fe3095cfd210ff911c4930406eabc252b1f843b76d9542e64032cd1acf1976af53c78c97f7fdfff54180aa88214d13a593282a54d797a545a3e92a6f45ad39cae11acd81066d9941a756f700ff4feedb495e3b113944ad75e265bf08b8fa5ed427af2cd61fded9b4640d780c685ea041b3634ec253a2f3b359736d04218530d8c52d70830683b64df254cd1c61f1b65b740e983696e31e8fe911515d6ed4d247a685159de54d3fd06ecc815426afc459c74c7e6bc5b91e72e144549f155f119fd9f6dbf1a185ab9210fe13e5ebf9a8eab4e67dc22aeb4b4e53e7983eb105cd509dda63ee9154681be9537e4d75e3c6b0f33b8ad4c15d8014acc9f90faaf57e48345f3fb27277266096c5090526b3982e6b6c16b89c3a6adf83ddf4d0cb7cef6d4d94f69c2f687ca7e7b77d464ff3f429e39ff97bba4fc01dfb7827f843b01426ce211527005ab122a32c7f606cf9c6da7e0e66610697b75124eb2476615377afb58a79c47a93b7f60ad48f9bfffecec187a94bfd43af6cda1679d5304fee96b34b96ee1414478e689bb9f2343cac8c1c979711c02df9fe8d90676ec9dd78815330831e95552d7fe446ef9e1e4d9ef5ba0cede61db222e514c3982744be8df64e498ca5fc0316c642481be950052e5479c0cb7e08d0c6f
c4caefd34c14f20d6e5d5d496b9130c94a2719c635338475812b91d52e6fdf827707bfde4976498e0cea63b689124db7fe0c675f80a0a0f75f87e793d096fca44326dbbe3647ac56059d01d47c95f03a66bf1a2654b96d9d04cc53ade5a91b9bc7085ddbd477eb8cde556e8cba8411c76ab826f42d1a80c94bfb6b396fd425a0d0a68610952313f8fb1698abb2909f2bd1416656299a51373addcd1bc834f8b7c2642f9f0a553ddeef53457052a4c6af38263cb0dec9a47278d845edae95735cad10b6ffdf05d892c9738e6cf6d7e3ab19810e2413937c498c79d1a8ee4cbbeef765acf362553b8d4650aad7ddcdf34ef1e6df7547322ef4a080ec87e707c130d8e84ac3dd7d1c7955ca8cec1d531d17546323a998ce663e737b020f68952ff62f78d2ad8543050fe6d2fa5c7d7156a1ea454d50c5dde94db0599b12c0f810c5fe61019679aeff621f234d0394a4399a5d81b6da353f56f1610c9525c744456f440287ebb4e86e30b453b122dfc6964c466a1d0af7f8256dd5b7b28e4edf5f917dd2b9df387f3f2505513e13109ecba422db6029d20cff8f68dc4321e4b8469cc5c984a0c7cef04f37bb0d9ccef98cf7583f466fdfc46340d8e45948311741496e6082be9e75ab70d86aaf748eb759da8ea83e5d028834ab23fe7466728447d132655f2bc3589df2cb6d77ca6c0da86d66f2657b
6dc512ce6e920807d459dea440fda8e798d758ee973c2d9c884f8bca68fe8d8564bfffb8366017b608a31c22737790df20920e182dd8ce5374741aa102622f20db55b9c5c7f0b5172d8656734d90eb8dedefae512039196067206e2430572ac7aeba7555ef2ea9f40b460e95edba0a2bb97936e3fb4fc457c9f801b2a1d3241bcc56c22a6945e75dc9cd6d48fba7483bb09e34940e9cbf81f8c5c8d754f170fc468c91f641294f3b0c24767ba2235e4a5d5c3fac6d50c53a76c1ddb5599570fdf1fb6c37dc16d0744b75c5c4278e1d8e335b9d40c773303e7e517916b23e17e24b22cfc3d40bbb7708a5727ecf3cb1455b3518af175b8a119c7b366fa143f98363326e074f3230ce28be3d22c73096e1d3d14c7bfe1e870e0b317e595e54986df8cf8fff1a679ae87290a84ca0c688d52b73ec16d24e4835e2d2f273098b190424d4363155d8db218486cba6fb16651c98c9fa46c65f9ccb0bbb07f10b7ee80a6ca9b558dafdfbda7ac8e2e42fac18cc9f2614256831ff974927bfa0070940ca6ba4c32f37501659cb10ce5f6df92dc77ff6963e05fc4dd837d39964fe15250ef56ed20364e2139d200e668d8eff95217d2b27283b6846785e847f8d017087ce327b7d9149a5f43c7f9b98718beb0df7845adff7fa09e86a1a8d821c75ad1dcbcc791dfc5423dbbd179e82c330808428a6378681
d3edd0d106dc14562bc564dd6b6e13d08da594ddfbec356788fdbbd95db4f2939d288ad14a66e78f20ed0ca16a3dafd2380186db07a3839825e1e26404b5d7a83edf178cb3be0318a035c37bdb5b576ca9ccc12231201d8f88f35d87189a0829650f608e25375ef38d31b2d1c8e74735188e0996d0cf6b241075395708476f9fec795220072c5c5a2ff1877fe2a1c0285cccf2b0da52ec9c47bd6828efada5d2a9da5192077e32211a55d8dfc91fec2bf36f16cd52ac8f98528e5dc0e40646b742319963eab686827a46eae751cb45aa8f872d6016542a92d4d837479e2b53c5622b327007ea2a3a77a8cd2247eb1782dfd3f00cd3d55b4a41b9e66ffe7491f52f5eb0d074d99e6e867c2347bcfa9efc262163ab15fc0602b69abf82cc9871ed5a8ad8cc0ef5fa26ead715dc0c8e82be95dba6ad5c10770ae83deaff02c6eef0a03ebacd235b5476c67cf04671c23d134076abbd55558bfebd0fd5f098851f9760d13a639c49471b1a4a40bce0ea9ab4cde6f673fb8aa2c407ece540fe464d82f7cd2634ccd2f7284680dae39794b291d5a797d44fe4248b42ab05298a0ea2e3bead315c288c426d73d0e277e8054b948f382641c317ab1e07089d975840d572e88497429d94477dce5b30bc9d823d293284e1b9e843277f224f86639857065fe66bd7
"""

# ------------------------------------------

def split(value, size=2):
    return tuple(value[0 + i:size + i] for i in range(0, len(value), size))


def hex2dec(value):
    if type(value) == str:
        value = value.strip()
        if ' ' not in value:
            return int(value, 16)
        else:
            return hex2dec(value.split(' '))
    else:
        return tuple(int(item, 16) for item in value)

# ------------------------------------------    

def collect(line):
    line = line[:-1].split(' ')
    if len(line) != 13: return None
    line, data = line[:-1], line[-1]
    t, phy, size, ft, fs, src, dst, fsn, ffn, chan, rate, rssi = line
    t, size = float(t), int(size)
    ft, fs = int(ft), int(fs)
    src, dst = src if src != str(None) else None, dst if dst != str(None) else None
    fsn, ffn = int(fsn) if fsn != str(None) else None, int(ffn) if ffn != str(None) else None
    chan, rssi = int(chan), int(rssi)
    rate = float(rate) if rate != str(None) else None
    return {'t':t, 'size':size, 'phy':phy, 
            'ft':ft, 'fs':fs, 'src':src, 'dst':dst,
            'sn':fsn, 'fn':ffn, 'chan':chan,
            'rate':rate, 'rssi':rssi, 'data':data}

# ------------------------------------------

def print_80211(name, sn, fn, size, vs, vf, data):
    vs = vs if vs != -1 else ''
    vf = vf if vf != -1 else ''
    print('{} {:4d} {:1d} {:>3} {:>3} {:4d} {}'.format(name, sn, fn, vs, vf, len(data), data[:10]))

# ------------------------------------------

def create_image_ffmpeg(data, fname):

    frame = hex2dec(split(data, 2))
    if os.path.isfile(fname): os.remove(fname)

    fmt = 'rgb24'  # rgb24, gray, ya8, rgba
    cmd = ('ffmpeg', '-v', 'warning', '-i', '-', '-f', 'image2pipe', '-pix_fmt', fmt, '-vcodec', 'rawvideo', '-')
    proc = sp.Popen(cmd, bufsize=10**8, stdin=sp.PIPE, stdout=sp.PIPE, stderr=sp.PIPE)        
    
    (out, err) = proc.communicate(np.asarray(frame, dtype='uint8').tostring())

    w, h = 960, 720  # TODO: extract image size from output of FFmpeg
    nbcomp, bitpix, shape = None, None, None
    if fmt == 'gray': nbcomp, bitpix, shape = 1, 8, (h, w)         # 145 kB
    elif fmt == 'ya8': nbcomp, bitpix, shape = 2, 16, (h, w, 2)    # 180 kB
    elif fmt == 'rgb24': nbcomp, bitpix, shape = 3, 24, (h, w, 3)  # 312 kB
    elif fmt == 'rgba': nbcomp, bitpix, shape = 4, 32, (h, w, 4)   # 331 kB

    if shape is None:
        print('shape is None', file=sys.stderr)
        return

    size = np.prod(shape)
    if len(out) >= size:  # enough data in stream?
        raw_image = out[:size]  # just the first frame in stream
        image = np.fromstring(raw_image, dtype='uint{}'.format(bitpix // nbcomp))
        image = image.reshape(shape)
        im = pil.fromarray(image)
        im.save(fname)
    else:
        print(err, file=sys.stderr)

# ------------------------------------------

if __name__ == '__main__':

#     frame = test_frame.replace('\n', '')
#     create_image_ffmpeg(frame, 'test.png')
#     exit()

    f = open('./video.log', 'r')

    sps, pps, key = None, None, None
    last, buffer = None, ''

    for line in f:        

        r = collect(line)
        
        if r['phy'] == 'g' and r['ft'] == 2:  # streaming
            
            sn, fn, size, data = r['sn'], r['fn'], r['size'], r['data']

            # ----------

            # avoid duplicates, i.e. avoid retransmitted frames and
            # check order, i.e. stay in this stream
            if last != (sn, fn) and (last is None or 0 <= sn - last[0] <= 10):
                last = (sn, fn)
            else:
                continue

            # ----------
            
            if fn == 0:  # chunk or first fragment of chunk
                qos, llc, ip, udp = 8 * 3 + 2, 8, 8 * 2 + 4, 8
                data = data[(qos + llc + ip + udp) * 2:]
                vsn, vfn = data[0:2], data[2:4]
                vsn = int(vsn, 16) if len(vsn) > 0 else -1  # app video sn
                vfn = int(vfn, 16) if len(vfn) > 0 else -1  # app video fn
                data = data[4:]  # cut off video app data

            else:  # fragment of chunk
                qos = 8 * 3 + 2
                vsn, vfn = -1, -1
                data = data[qos * 2:]

            data = data[:-8]  # cut off crc

            # ----------

            if '0000000167' == data[:10]:  # SPS
                sps, pps, key, buffer = vsn, None, None, ''
                buffer += data
                print_80211('SPS', sn, fn, size, vsn, vfn, data)                
                            
            if '0000000168' == data[:10] and sps is not None:  # PPS
                if vsn == sps + 1:
                    pps = vsn
                    buffer += data
                    print_80211('PPS', sn, fn, size, vsn, vfn, data)
                else:
                    sps, buffer = None, ''
             
            if '0000000165' == data[:10] and pps is not None:  # keyframe
                if vsn == pps + 1:                    
                    key = vsn
                else:
                    pps, buffer = None, ''

            if key is not None:
                buffer += data
                print_80211('KEY', sn, fn, size, vsn, vfn, data)

            # ----------

            if fn == 0 and vsn == key and vfn // 128 == 1:  # indicator for last chunk
                sps, pps = None, None

            if sps is None and pps is None and vsn != key:  # last fragment of last chunk
                if len(buffer) > 0: create_image_ffmpeg(buffer, '{}.png'.format(key))
                sps, pps, key, buffer = None, None, None, ''

            # ----------

            if '0000000141' == data[:10]:  # for sure, reset (optionally)
                sps, pps, key, buffer = None, None, None, ''
